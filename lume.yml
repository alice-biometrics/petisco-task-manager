name: taskmanager

install:
  run:
  - pip install -r requirements/dev.txt -r requirements/test.txt -r requirements/requirements.txt

steps:
  clean:
    run:
    - rm -rf deps
    - rm -rf output
    - rm -rf docs/build
    - find . | grep -E "(__pycache__|\.pyc|\.pyo$)" | xargs rm -rf
  lint:
    run:
    - black .
    - flake8 taskmanager
  test:
    run:
    - pytest
  docker-rebuild:
    run:
      - docker-compose build --pull --force-rm --no-cache
  test-e2e-local:
    run:
      - docker-compose up -d
      - export END2END_TEST=True; pytest -m end2end --variables tests/end2end/envs/local.yml
      - docker-compose down
  test-e2e-staging:
    run:
      - export END2END_TEST=True; pytest -m end2end --variables tests/end2end/envs/staging.yml
  test-e2e-pro:
    run:
      - export END2END_TEST=True; pytest -m end2end --variables tests/end2end/envs/pro.yml